(()=>{"use strict";const e=async e=>{const s=await fetch(e.input,e.init);e.callback(await s.json())};class s{constructor(e){this.url=e}create(s,t){e({input:`${this.url}new-user`,init:{method:"POST",body:JSON.stringify({name:s})},callback:t})}}class t extends s{sendNickname(e,s){this.create(e,s)}}class n{static init(){document.querySelector("body").insertAdjacentHTML("beforeend",'\n      <div class="modal__background">\n        <div class="modal__content">\n          <div class="modal__header">Выберите псевдоним</div>\n          <div class="modal__body">\n            <form class="modal__form">\n              <div class="form__group">\n                <label class="form__label" for="name"></label>\n                <input class="form__input" name="name" id="name">\n              </div>\n              <div class="form__group">\n                <button class="modal__ok">Продолжить</button>\n              </div>\n            </form>\n          </div>\n          <div class="modal__footer"></div>\n        </div>\n      </div>\n    ')}static remove(){const e=document.querySelector(".modal__background");e&&e.remove()}static addHint(e,s){s.insertAdjacentHTML("beforebegin",`<div class="form__hint">${e}</div>`)}static removeHint(e){e.parentElement.querySelectorAll(".form__hint").forEach((e=>e.remove()))}}const i=document.getElementById("root");new class{constructor(e){this.container=e,this.api=new t("https://ahj-homeworks-sse-ws-chat-backend-7gs4.onrender.com/"),this.websocket=null,this.user=null,this.users=[]}init(){this.bindToDOM(),n.init(),this.registerEvents()}bindToDOM(){this.onSubmit=this.onSubmit.bind(this),this.onEnterChatHandler=this.onEnterChatHandler.bind(this)}registerEvents(){document.querySelector(".modal__form").addEventListener("submit",this.onSubmit)}onSubmit(e){e.preventDefault();const s=e.target.name,t=s.value;t?(n.removeHint(s),this.api.sendNickname(t,this.sendNicknameHandler.bind(this,s))):n.addHint("Введите ваш псевдоним!",s)}sendNicknameHandler(e,s){"ok"===s.status?(this.user=s.user,this.subscribeOnEvents(),n.remove()):n.addHint(s.message,e)}subscribeOnEvents(){this.websocket=new WebSocket("wss://ahj-homeworks-sse-ws-chat-backend-7gs4.onrender.com/"),this.websocket.addEventListener("open",(()=>{this.renderChat();document.querySelector(".form").addEventListener("submit",this.onEnterChatHandler);document.querySelector(".chat__connect").addEventListener("click",(()=>{this.websocket.send(JSON.stringify({type:"exit",user:this.user})),this.websocket.close(),this.container.innerHTML="",this.init()}))})),this.websocket.addEventListener("message",(e=>{const s=JSON.parse(e.data);if(Array.isArray(s))this.users=s,this.renderUsers();else{const e=document.querySelector(".chat__messages-container"),t=this.renderMessage(s);e.insertAdjacentHTML("beforeend",t)}console.log(e,s)}))}onEnterChatHandler(e){e.preventDefault();const s=e.target.querySelector(".form__input"),t=s.value;t&&(this.sendMessage(t),s.value="")}sendMessage(e){const s=JSON.stringify({type:"send",msg:e,date:Date.now(),userId:this.user.id});this.websocket.send(s)}renderMessage(e){const s=e.userId===this.user.id?" message__container-yourself":"";let{name:t}=this.users.filter((s=>s.id===e.userId))[0];return t===this.user.name&&(t="You"),`\n      <div class="message__container${s}">\n        <div class="message__header">\n          ${t}, ${new Date(e.date).toLocaleDateString(void 0,{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}\n        </div>\n        <div class="message__container-interlocutor">\n          ${e.msg}\n        </div>\n      </div>\n    `}renderUsers(){const e=document.querySelector(".chat__userlist");e.innerHTML="",this.users.forEach((s=>{const t=document.createElement("div");t.classList.add("chat__user"),s.id===this.user.id?(t.classList.add("chat__user-yourself"),t.innerText="You"):t.innerText=s.name,e.appendChild(t)}))}renderChat(){this.container.insertAdjacentHTML("beforeend",'\n      <div class="container">\n        <div class="chat__header">\n          <h1>Чат</h1>\n          <div class="chat__connect">Отключиться</div>\n        </div>\n        <div class="chat__container">\n          <div class="chat__userlist"></div>\n          <div class="chat__area">\n            <div class="chat__messages-container"></div>\n            <div class="chat__messages-input">\n              <form class="form">\n                <div class="form__group">\n                  <input type="text" class="form__input">\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n      </div>\n    ')}}(i).init()})();